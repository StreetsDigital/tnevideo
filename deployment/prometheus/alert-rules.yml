# Prometheus Alert Rules for TNE Catalyst
# These rules define when to send alerts for various failure conditions

groups:
  - name: pbs_critical
    interval: 30s
    rules:
      # Service is down
      - alert: CatalystServiceDown
        expr: up{job="catalyst"} == 0
        for: 1m
        labels:
          severity: critical
          component: catalyst
        annotations:
          summary: "Catalyst service is down"
          description: "Catalyst service has been down for more than 1 minute."

      # High error rate
      - alert: HighErrorRate
        expr: rate(pbs_http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          component: catalyst
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

      # Database connection failures
      - alert: DatabaseConnectionFailure
        expr: pbs_database_connection_errors_total > 0
        for: 1m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Database connection failures detected"
          description: "{{ $value }} database connection errors in the last minute"

      # Redis connection failures
      - alert: RedisConnectionFailure
        expr: pbs_redis_connection_errors_total > 0
        for: 1m
        labels:
          severity: critical
          component: redis
        annotations:
          summary: "Redis connection failures detected"
          description: "{{ $value }} Redis connection errors in the last minute"

  - name: pbs_warnings
    interval: 1m
    rules:
      # High response time
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(pbs_http_request_duration_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
          component: catalyst
        annotations:
          summary: "High response time detected"
          description: "95th percentile response time is {{ $value | humanizeDuration }} (threshold: 500ms)"

      # High CPU usage
      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total{job="catalyst"}[5m]) * 100 > 80
        for: 10m
        labels:
          severity: warning
          component: infrastructure
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value | humanize }}% (threshold: 80%)"

      # High memory usage
      - alert: HighMemoryUsage
        expr: (process_resident_memory_bytes{job="catalyst"} / 4294967296) * 100 > 80
        for: 10m
        labels:
          severity: warning
          component: infrastructure
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value | humanize }}% of 4GB (threshold: 80%)"

      # Low auction success rate
      - alert: LowAuctionSuccessRate
        expr: rate(pbs_auctions_total{result="success"}[10m]) / rate(pbs_auctions_total[10m]) < 0.9
        for: 15m
        labels:
          severity: warning
          component: auctions
        annotations:
          summary: "Low auction success rate"
          description: "Auction success rate is {{ $value | humanizePercentage }} (threshold: 90%)"

      # High privacy violation rate
      - alert: HighPrivacyViolationRate
        expr: rate(pbs_privacy_violations_total[10m]) > 0.01
        for: 15m
        labels:
          severity: warning
          component: privacy
        annotations:
          summary: "High privacy violation rate"
          description: "Privacy violation rate is {{ $value | humanize }} per second (threshold: 0.01/s)"

  - name: pbs_backups
    interval: 5m
    rules:
      # Backup failure
      - alert: BackupFailure
        expr: time() - pbs_last_backup_timestamp_seconds > 90000
        for: 5m
        labels:
          severity: warning
          component: backups
        annotations:
          summary: "Backup has not run in 25 hours"
          description: "Last successful backup was {{ $value | humanizeDuration }} ago (threshold: 25 hours)"

      # Backup age (critical)
      - alert: BackupTooOld
        expr: time() - pbs_last_backup_timestamp_seconds > 172800
        for: 1m
        labels:
          severity: critical
          component: backups
        annotations:
          summary: "No backup in 48 hours"
          description: "Last successful backup was {{ $value | humanizeDuration }} ago (threshold: 48 hours)"

  - name: pbs_infrastructure
    interval: 1m
    rules:
      # Disk space low
      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 15
        for: 5m
        labels:
          severity: warning
          component: infrastructure
        annotations:
          summary: "Low disk space"
          description: "Disk space is {{ $value | humanize }}% available (threshold: 15%)"

      # Disk space critical
      - alert: DiskSpaceCritical
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 10
        for: 1m
        labels:
          severity: critical
          component: infrastructure
        annotations:
          summary: "Critical disk space"
          description: "Disk space is {{ $value | humanize }}% available (threshold: 10%)"

      # Too many goroutines
      - alert: TooManyGoroutines
        expr: go_goroutines{job="catalyst"} > 10000
        for: 10m
        labels:
          severity: warning
          component: catalyst
        annotations:
          summary: "High number of goroutines"
          description: "{{ $value }} goroutines running (threshold: 10,000)"

      # Database connection pool exhausted
      - alert: DatabasePoolExhausted
        expr: pbs_database_connections_in_use / pbs_database_connections_max > 0.9
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Database connection pool nearly exhausted"
          description: "{{ $value | humanizePercentage }} of connections in use (threshold: 90%)"

  - name: pbs_business_metrics
    interval: 5m
    rules:
      # Revenue drop
      - alert: RevenueDrop
        expr: rate(pbs_revenue_usd_total[1h]) < rate(pbs_revenue_usd_total[1h] offset 24h) * 0.5
        for: 1h
        labels:
          severity: warning
          component: business
        annotations:
          summary: "Significant revenue drop detected"
          description: "Revenue is 50% lower than same time yesterday"

      # No auctions
      - alert: NoAuctions
        expr: rate(pbs_auctions_total[5m]) == 0
        for: 10m
        labels:
          severity: critical
          component: auctions
        annotations:
          summary: "No auctions being processed"
          description: "No auctions have been processed in the last 10 minutes"

      # Low bid rate
      - alert: LowBidRate
        expr: rate(pbs_bids_received_total[10m]) / rate(pbs_auctions_total[10m]) < 1
        for: 30m
        labels:
          severity: warning
          component: bidders
        annotations:
          summary: "Low bid rate"
          description: "Average bids per auction is {{ $value | humanize }} (threshold: <1)"

  - name: pbs_security
    interval: 1m
    rules:
      # High authentication failure rate
      - alert: HighAuthFailureRate
        expr: rate(pbs_auth_failures_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: security
        annotations:
          summary: "High authentication failure rate"
          description: "{{ $value | humanize }} auth failures per second (threshold: 10/s)"

      # Possible DDoS attack
      - alert: PossibleDDoS
        expr: rate(pbs_http_requests_total[1m]) > 10000
        for: 2m
        labels:
          severity: critical
          component: security
        annotations:
          summary: "Possible DDoS attack"
          description: "{{ $value | humanize }} requests per second (threshold: 10,000/s)"

      # Rate limit violations
      - alert: HighRateLimitViolations
        expr: rate(pbs_rate_limit_violations_total[5m]) > 100
        for: 5m
        labels:
          severity: warning
          component: security
        annotations:
          summary: "High rate limit violations"
          description: "{{ $value | humanize }} rate limit violations per second"

  - name: pbs_data_quality
    interval: 5m
    rules:
      # High invalid bid request rate
      - alert: HighInvalidBidRequestRate
        expr: rate(pbs_bid_requests_invalid_total[10m]) / rate(pbs_bid_requests_total[10m]) > 0.1
        for: 15m
        labels:
          severity: warning
          component: data_quality
        annotations:
          summary: "High invalid bid request rate"
          description: "{{ $value | humanizePercentage }} of bid requests are invalid (threshold: 10%)"

      # Missing geo data
      - alert: MissingGeoData
        expr: rate(pbs_requests_missing_geo_total[10m]) / rate(pbs_bid_requests_total[10m]) > 0.5
        for: 15m
        labels:
          severity: warning
          component: data_quality
        annotations:
          summary: "High rate of requests missing geo data"
          description: "{{ $value | humanizePercentage }} of requests missing geo (threshold: 50%)"
